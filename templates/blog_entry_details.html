{% extends 'base.html' %}
{% block head %}
<title>Blog App:{{post.title}}</title>
<link rel="stylesheet" href="/static/css/style.css">
<link rel="stylesheet" href="/static/css/blog_entries_list.css">
<link rel="stylesheet" href="/static/css/comments.css">
<link rel="stylesheet" href="/static/css/blog_entry_details.css">

{% endblock %}

{% block content %}

<div class="container">
    <div class="edit">
        <form 
            action="{% url 'edit_blog_entry' blog_id=post.id %}"
            method="get"
            onsubmit="return confirm('Are you sure you want to edit this post?');">
            {% csrf_token %}
            <button type="submit" class="btn-edit"><svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <path d="M15.4998 5.49994L18.3282 8.32837M3 20.9997L3.04745 20.6675C3.21536 19.4922 3.29932 18.9045 3.49029 18.3558C3.65975 17.8689 3.89124 17.4059 4.17906 16.9783C4.50341 16.4963 4.92319 16.0765 5.76274 15.237L17.4107 3.58896C18.1918 2.80791 19.4581 2.80791 20.2392 3.58896C21.0202 4.37001 21.0202 5.63634 20.2392 6.41739L8.37744 18.2791C7.61579 19.0408 7.23497 19.4216 6.8012 19.7244C6.41618 19.9932 6.00093 20.2159 5.56398 20.3879C5.07171 20.5817 4.54375 20.6882 3.48793 20.9012L3 20.9997Z" stroke="#000000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path> </g></svg>
                Edit</button>
        </form>
    </div>
    <div class="entries_categories">
        <a href="{% url 'all_blog_entries' %}" class="category">All</a>
        {% for category in categories %}
        <a
            class="category {% if category.id == post.category.id %}active{% endif %}"
            href="{% url 'all_blog_entries' %}?category={{category.title}}">{{category.title}}</a>
        {% endfor %}
    </div>

    <div class="blog-detail-card">
        <div class="blog-header">
            <img src="/static/img/blog_cart.png" alt="{{ post.title }}">
            <p class="blog-header-category">{{post.category.title}}</p>
            <p class="blog-header-rating">
                <strong>{{post.rating|floatformat:1}}</strong>
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1"
                    id="Layer_1" viewBox="0 0 501.986 501.986"
                    xml:space="preserve"
                    fill="#000000"><g id="SVGRepo_bgCarrier"
                        stroke-width="0"></g><g
                        id="SVGRepo_tracerCarrier" stroke-linecap="round"
                        stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier">
                        <g>
                            <g>
                                <path
                                    d="M287.442,42.472l42.984,87.096c5.921,11.997,17.365,20.312,30.604,22.235l96.116,13.966 c33.339,4.844,46.651,45.815,22.527,69.331l-69.55,67.795c-9.58,9.338-13.951,22.792-11.69,35.978l16.419,95.728 c5.695,33.204-29.157,58.526-58.976,42.849l-85.969-45.196c-11.841-6.225-25.988-6.225-37.829,0l-85.969,45.196 c-29.819,15.677-64.671-9.644-58.976-42.849l16.419-95.728c2.261-13.185-2.11-26.639-11.69-35.978L22.312,235.1 C-1.812,211.585,11.5,170.614,44.839,165.77l96.116-13.966c13.239-1.924,24.684-10.239,30.604-22.235l42.984-87.096 C229.454,12.262,272.533,12.262,287.442,42.472z"></path>
                                <path
                                    d="M374.839,492.172c-8.05,0-16.139-1.941-23.616-5.872l-85.969-45.196c-8.931-4.694-19.593-4.693-28.521,0L150.764,486.3 c-17.189,9.037-37.628,7.56-53.338-3.855C81.715,471.03,73.995,452.05,77.277,432.91l16.419-95.728 c1.705-9.944-1.59-20.084-8.813-27.126l-69.551-67.794C1.426,228.707-3.484,208.813,2.517,190.343 c6-18.469,21.667-31.677,40.885-34.469l96.115-13.967c9.984-1.451,18.61-7.718,23.075-16.765l42.984-87.096 c8.595-17.414,25.998-28.232,45.417-28.232s36.822,10.818,45.417,28.232l0,0l42.984,87.096 c4.465,9.047,13.091,15.314,23.075,16.765l96.115,13.967c19.218,2.792,34.885,16,40.885,34.469 c6.001,18.469,1.091,38.363-12.815,51.918l-69.55,67.794c-7.225,7.042-10.52,17.183-8.814,27.127l16.419,95.727 c3.282,19.14-4.438,38.121-20.148,49.535C395.685,488.895,385.295,492.172,374.839,492.172z M250.993,417.582 c8.096,0,16.188,1.939,23.567,5.819l85.969,45.196c10.559,5.551,22.625,4.679,32.275-2.333s14.208-18.217,12.191-29.974 l-16.419-95.728c-2.817-16.434,2.628-33.192,14.567-44.829l69.549-67.794c8.543-8.327,11.442-20.071,7.756-31.417 c-3.687-11.345-12.935-19.142-24.739-20.857l-96.117-13.967c-16.499-2.397-30.754-12.755-38.134-27.706l-42.984-87.096 c-5.279-10.697-15.553-17.083-27.481-17.083c-11.929,0-22.202,6.386-27.481,17.083l-42.984,87.096 c-7.38,14.951-21.635,25.308-38.134,27.706l-96.116,13.967c-11.806,1.715-21.054,9.513-24.74,20.857 c-3.687,11.345-0.787,23.09,7.756,31.416l69.55,67.794c11.938,11.637,17.384,28.396,14.566,44.829L96.99,436.291 c-2.017,11.757,2.541,22.962,12.191,29.974c9.651,7.012,21.717,7.884,32.275,2.333l85.969-45.196 C234.804,419.522,242.899,417.582,250.993,417.582z"></path>
                            </g> <g> <path
                                    d="M231.978,103.014c-1.486,0-2.994-0.333-4.418-1.035c-4.952-2.444-6.985-8.44-4.542-13.393l8.559-17.342 c2.444-4.953,8.438-6.988,13.394-4.542c4.952,2.444,6.985,8.44,4.542,13.393l-8.559,17.342 C239.211,100.966,235.664,103.014,231.978,103.014z"></path>
                            </g> <g> <path
                                    d="M145.668,198.093c-4.887,0-9.16-3.585-9.884-8.563c-0.794-5.465,2.993-10.54,8.458-11.334 c23.306-3.387,43.441-18.017,53.863-39.134l9.612-19.476c2.443-4.953,8.44-6.986,13.394-4.542 c4.952,2.444,6.985,8.44,4.542,13.393l-9.612,19.476c-13.337,27.021-39.102,45.741-68.922,50.075 C146.632,198.059,146.147,198.093,145.668,198.093z"></path>
                            </g> </g> </g>
                </svg>
            </p>
            <button
                class="bookmark {% if is_post_saved %} active  {% endif %} "
                data-post-id="{{post.id}}"> 

                <svg fill="#ffffff" viewBox="0 0 256 256" id="Flat" xmlns="http://www.w3.org/2000/svg"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <g opacity="0.2"> <path d="M191.9707,224l-64.0074-40L63.9707,224V48a8,8,0,0,1,8-8h112a8,8,0,0,1,8,8Z"></path> </g> <path d="M183.9707,32h-112a16.01833,16.01833,0,0,0-16,16V224a8.00043,8.00043,0,0,0,12.24024,6.78418l59.75293-37.35059L187.731,230.78418A8,8,0,0,0,199.9707,224V48A16.01833,16.01833,0,0,0,183.9707,32Zm0,177.56738-51.76758-32.35156a8.00107,8.00107,0,0,0-8.48,0L71.9707,209.56543V48h112Z"></path> </g></svg>
            </button>
            
        </div>
        <div class="blog-detail-content-wrapper">
            <div class="blog-detail-header">
                <h1 class="blog-detail-title">{{post.title}}</h1>
                <div class="blog-detail-meta">
                    <span class="blog-detail-author">By:
                        {% if post.user.username %}
                        <a href="{% url 'profile' username=post.user.username %}">
                            {{post.user.username|default:'Unknown Author'}}
                        </a>
                        {% else %}
                        {{post.user.username|default:'Unknown Author'}}
                        {% endif %}
                        </span>
                    <span class="blog-detail-date">Published on:
                    {{post.created_at|date:"F d, Y"}}</span>
                    
                </div>
            </div>
            <div class="blog-detail-content">
                {{post.content|truncatecharacters:200|safe}}
            </div>
        </div>
    </div>

    <div class="comments-section">
        <h2 class="comments-header">Comments ({{ comments.count }})</h2>
        {% for comment in comments %}
        <div class="comment-card">
            <div class="comment-header">
                <div class="comment-header-data">
                    <span class="comment-author">
                        {% if comment.user.username %}
                        <a href="{% url 'profile' username=comment.user.username %}">
                        {{comment.user.username|default:'Anonymous' }}
                        </a>
                        {% else %}
                        {{comment.user.username|default:'Anonymous' }}
                        {% endif %}
                    </span>
                    <div class="comment-stars">
                        {% for i in "12345" %}
                        {% if i|add:0 <= comment.stars %}
                        <span class="star filled">&#9733;</span>
                        {# filled star #}
                        {% else %}
                        <span class="star">&#9734;</span> {# empty star #}
                        {% endif %}
                        {% endfor %}
                    </div>
                </div>

                <span class="comment-date">
                    {{ comment.created_at|date:"F d, Y"}}
                </span>
            </div>
            <div class="comment-body">

                <p class="comment-content">
                    {{ comment.content|truncatecharacters:200|linebreaksbr}}
                </p>
            </div>
        </div>
        {% empty %}
        <p>No comments yet. Be the first to comment!</p>
        {% endfor %}
    </div>

    <form class="comment-form" method="post">
        {%csrf_token%}
        <div class="stars-group">
            {% for i in "54321" %}
            <input type="radio" name="rating" id="star-{{i}}" value="{{i}}"
                required>
            <label for="star-{{i}}">
                <svg xmlns="http://www.w3.org/2000/svg"
                    xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1"
                    id="Layer_1" viewBox="0 0 501.986 501.986"
                    xml:space="preserve"
                    fill="#000000"><g id="SVGRepo_bgCarrier"
                        stroke-width="0"></g><g
                        id="SVGRepo_tracerCarrier" stroke-linecap="round"
                        stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier">
                        <g>
                            <g>
                                <path
                                    d="M287.442,42.472l42.984,87.096c5.921,11.997,17.365,20.312,30.604,22.235l96.116,13.966 c33.339,4.844,46.651,45.815,22.527,69.331l-69.55,67.795c-9.58,9.338-13.951,22.792-11.69,35.978l16.419,95.728 c5.695,33.204-29.157,58.526-58.976,42.849l-85.969-45.196c-11.841-6.225-25.988-6.225-37.829,0l-85.969,45.196 c-29.819,15.677-64.671-9.644-58.976-42.849l16.419-95.728c2.261-13.185-2.11-26.639-11.69-35.978L22.312,235.1 C-1.812,211.585,11.5,170.614,44.839,165.77l96.116-13.966c13.239-1.924,24.684-10.239,30.604-22.235l42.984-87.096 C229.454,12.262,272.533,12.262,287.442,42.472z"></path>
                                <path
                                    d="M374.839,492.172c-8.05,0-16.139-1.941-23.616-5.872l-85.969-45.196c-8.931-4.694-19.593-4.693-28.521,0L150.764,486.3 c-17.189,9.037-37.628,7.56-53.338-3.855C81.715,471.03,73.995,452.05,77.277,432.91l16.419-95.728 c1.705-9.944-1.59-20.084-8.813-27.126l-69.551-67.794C1.426,228.707-3.484,208.813,2.517,190.343 c6-18.469,21.667-31.677,40.885-34.469l96.115-13.967c9.984-1.451,18.61-7.718,23.075-16.765l42.984-87.096 c8.595-17.414,25.998-28.232,45.417-28.232s36.822,10.818,45.417,28.232l0,0l42.984,87.096 c4.465,9.047,13.091,15.314,23.075,16.765l96.115,13.967c19.218,2.792,34.885,16,40.885,34.469 c6.001,18.469,1.091,38.363-12.815,51.918l-69.55,67.794c-7.225,7.042-10.52,17.183-8.814,27.127l16.419,95.727 c3.282,19.14-4.438,38.121-20.148,49.535C395.685,488.895,385.295,492.172,374.839,492.172z M250.993,417.582 c8.096,0,16.188,1.939,23.567,5.819l85.969,45.196c10.559,5.551,22.625,4.679,32.275-2.333s14.208-18.217,12.191-29.974 l-16.419-95.728c-2.817-16.434,2.628-33.192,14.567-44.829l69.549-67.794c8.543-8.327,11.442-20.071,7.756-31.417 c-3.687-11.345-12.935-19.142-24.739-20.857l-96.117-13.967c-16.499-2.397-30.754-12.755-38.134-27.706l-42.984-87.096 c-5.279-10.697-15.553-17.083-27.481-17.083c-11.929,0-22.202,6.386-27.481,17.083l-42.984,87.096 c-7.38,14.951-21.635,25.308-38.134,27.706l-96.116,13.967c-11.806,1.715-21.054,9.513-24.74,20.857 c-3.687,11.345-0.787,23.09,7.756,31.416l69.55,67.794c11.938,11.637,17.384,28.396,14.566,44.829L96.99,436.291 c-2.017,11.757,2.541,22.962,12.191,29.974c9.651,7.012,21.717,7.884,32.275,2.333l85.969-45.196 C234.804,419.522,242.899,417.582,250.993,417.582z"></path>
                            </g> <g> <path
                                    d="M231.978,103.014c-1.486,0-2.994-0.333-4.418-1.035c-4.952-2.444-6.985-8.44-4.542-13.393l8.559-17.342 c2.444-4.953,8.438-6.988,13.394-4.542c4.952,2.444,6.985,8.44,4.542,13.393l-8.559,17.342 C239.211,100.966,235.664,103.014,231.978,103.014z"></path>
                            </g> <g> <path
                                    d="M145.668,198.093c-4.887,0-9.16-3.585-9.884-8.563c-0.794-5.465,2.993-10.54,8.458-11.334 c23.306-3.387,43.441-18.017,53.863-39.134l9.612-19.476c2.443-4.953,8.44-6.986,13.394-4.542 c4.952,2.444,6.985,8.44,4.542,13.393l-9.612,19.476c-13.337,27.021-39.102,45.741-68.922,50.075 C146.632,198.059,146.147,198.093,145.668,198.093z"></path>
                            </g> </g> </g></svg>
            </label>

            {% endfor %}
        </div>

        {{form.stars}}
        {{form.content}}
        <button type="submit">Confirm</button>
    </form>

    {% if recommended_posts %}
    <div class="blogs">
        <div class="blogs-header">
            <h2>Recommended Blogs</h2>
        </div>
        <div class="blogs-list">
            {% for r_post in recommended_posts %}
            <div class="blog">
                <a href="{% url 'blog_entry_details' blog_id=r_post.id %}"
                    class="blog-link">
                    <div class="blog-header">
                        <img src="/static/img/blog_cart.png" alt>
                        <p
                            class="blog-header-category">{{r_post.category.title}}</p>
                    </div>
                    <div class="blog-content">
                        <h2 class="blog-title">{{r_post.title}}</h2>
                        <div
                            class="blog-description">{{r_post.content|truncatewords_html:20|safe}}</div>
                        <div class="blog-content-created">
                            <p
                                class="blog-content-created-date">{{r_post.created_at|date:"d/m/Y"}}</p>
                            <p
                                class="blog-content-created-author">{{r_post.user.username|default:'Unknown'}}</p>
                        </div>
                    </div>
                </a>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>

<script>
    document.addEventListener("DOMContentLoaded", ()=>{
        const stars=document.querySelectorAll(".stars-group input")
        const hiddenStarsInput=document.querySelector(".comment-form input[name='stars']")
        stars.forEach((star)=>{
            star.addEventListener("change",()=>{
                console.log("Star: ", star.value);
                hiddenStarsInput.value=star.value;
            })
        })


        const saveBtn=document.querySelector(".bookmark")
        saveBtn.addEventListener("click", (e)=>{
            const postId=saveBtn.dataset.postId;
            const csfrToken=document.querySelector('[name=csrfmiddlewaretoken]').value;

            console.log("PostId: ", postId);
            console.log("CSRF Token: ", csfrToken);

            fetch(`/entries/${postId}/toggle_save/`, {
                method:"POST",
                headers:{
                    "X-CSRFToken":csfrToken,
                    "Content-Type":"application/json"
                }
            })
            .then(response=>response.json())
            .then(data=>{
                if (data.isSaved){
                    saveBtn.classList.add("active")
                }else{
                    saveBtn.classList.remove("active")
                }
            });
        })
        
    })
</script>

{% endblock %}